<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manus.ai - Manager</title>
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Carregando React e Babel em modo Global para funcionar em Celulares e file:// -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- QR Code Library compatível com navegadores antigos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: { 50: '#f0f9ff', 100: '#e0f2fe', 500: '#0ea5e9', 600: '#0284c7', 900: '#0c4a6e' },
            dark: { 800: '#1e293b', 900: '#0f172a' }
          }
        }
      }
    }
  </script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // --- ICONES SVG (Integrados para não depender de internet/libs externas) ---
    const Icon = ({ name, size = 20, className = "" }) => {
      const icons = {
        shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
        key: <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />,
        dashboard: <path d="M3 3h7v7H3V3zm11 0h7v7h-7V3zm0 11h7v7h-7v-7zM3 14h7v7H3v-7z" />,
        server: <path d="M2 12h20M2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6M2 12V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v6" />,
        plus: <path d="M12 5v14M5 12h14" />,
        trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
        copy: <path d="M8 4H6a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-2M16 4h2a2 2 0 0 1 2 2v4M21 14H11" />,
        refresh: <path d="M23 4v6h-6M1 20v-6h6" />,
        logout: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />,
        lock: <path d="M19 11H5m14 0a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2m14 0V9a7 7 0 0 0-14 0v2" />,
        cloud: <path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z" />,
        download: <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4M7 10l5 5 5-5M12 15V3" />
      };
      
      return (
        <svg 
          xmlns="http://www.w3.org/2000/svg" 
          width={size} 
          height={size} 
          viewBox="0 0 24 24" 
          fill="none" 
          stroke="currentColor" 
          strokeWidth="2" 
          strokeLinecap="round" 
          strokeLinejoin="round" 
          className={className}
        >
          {icons[name] || <circle cx="12" cy="12" r="10" />}
        </svg>
      );
    };

    // --- COMPONENTE QR CODE (Wrapper seguro) ---
    const QRCodeDisplay = ({ value }) => {
      const qrRef = useRef(null);
      
      useEffect(() => {
        if (qrRef.current) {
          qrRef.current.innerHTML = "";
          try {
            new QRCode(qrRef.current, {
              text: value,
              width: 200,
              height: 200,
              colorDark : "#000000",
              colorLight : "#ffffff",
              correctLevel : QRCode.CorrectLevel.M
            });
          } catch(e) {
            qrRef.current.innerHTML = "Erro ao gerar QR Code. Tente copiar o código manual.";
          }
        }
      }, [value]);

      return <div className="bg-white p-4 rounded shadow-lg" ref={qrRef}></div>;
    };

    // --- SISTEMA DE LICENÇAS ---
    const MASTER_KEY = "manus-admin-2024";
    const SALT = "manus_secret_salt_v1";

    const generateLicense = (clientName, daysValid) => {
      const expiryDate = new Date();
      expiryDate.setDate(expiryDate.getDate() + parseInt(daysValid));
      const payload = { c: clientName, e: expiryDate.getTime(), s: btoa(clientName + expiryDate.getTime() + SALT) };
      return btoa(JSON.stringify(payload));
    };

    const validateLicense = (key) => {
      if (!key) return null;
      if (key === MASTER_KEY) return { type: 'admin', name: 'Administrador' };
      try {
        const json = atob(key);
        const payload = JSON.parse(json);
        const expectedSig = btoa(payload.c + payload.e + SALT);
        if (payload.s !== expectedSig) return null;
        if (Date.now() > payload.e) return { type: 'expired', name: payload.c };
        return { type: 'client', name: payload.c, expires: payload.e };
      } catch (e) { return null; }
    };

    // --- CRYPTO UTILS ---
    const generateWGKey = () => {
      const bytes = new Uint8Array(32);
      window.crypto.getRandomValues(bytes);
      let binary = '';
      for (let i = 0; i < bytes.length; i++) binary += String.fromCharCode(bytes[i]);
      return window.btoa(binary);
    };

    const getPublicIP = async () => {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch (error) { return 'IP_DA_ORACLE_AQUI'; }
    };

    // --- STORAGE ---
    const STORAGE_KEY = 'manus_agents_v2';
    const getAgents = () => { const d = localStorage.getItem(STORAGE_KEY); return d ? JSON.parse(d) : []; };
    const saveAgent = (a) => { const c = getAgents(); localStorage.setItem(STORAGE_KEY, JSON.stringify([...c.filter(x => x.id !== a.id), a])); };
    const deleteAgent = (id) => { localStorage.setItem(STORAGE_KEY, JSON.stringify(getAgents().filter(a => a.id !== id))); };

    // --- TELAS ---

    const Login = ({ onLogin }) => {
      const [key, setKey] = useState('');
      const [error, setError] = useState('');
      const handleSubmit = (e) => {
        e.preventDefault();
        const res = validateLicense(key.trim());
        if(!res) setError('Chave inválida'); else if(res.type==='expired') setError('Licença expirada'); else onLogin(res);
      };
      return (
        <div className="min-h-screen bg-dark-800 flex items-center justify-center p-4">
          <div className="w-full max-w-md bg-dark-900 border border-slate-700 p-8 rounded-2xl shadow-2xl">
            <div className="flex justify-center mb-6"><div className="w-16 h-16 bg-brand-600 rounded-2xl flex items-center justify-center"><Icon name="shield" size={40} className="text-white"/></div></div>
            <h1 className="text-2xl font-bold text-center text-white mb-2">Manus.ai</h1>
            <p className="text-center text-slate-400 mb-6">Insira sua chave de acesso</p>
            <form onSubmit={handleSubmit} className="space-y-4">
              <input type="text" className="w-full bg-black border border-slate-600 rounded px-4 py-3 text-white text-center font-mono outline-none focus:border-brand-500" placeholder="Sua Chave..." value={key} onChange={e=>setKey(e.target.value)} />
              {error && <div className="text-red-400 text-sm text-center bg-red-900/20 p-2 rounded">{error}</div>}
              <button className="w-full bg-brand-600 hover:bg-brand-500 text-white font-bold py-3 rounded transition-all">Entrar</button>
            </form>
          </div>
        </div>
      );
    };

    const LicenseGenerator = () => {
      const [name, setName] = useState('');
      const [days, setDays] = useState(30);
      const [genKey, setGenKey] = useState('');
      return (
        <div className="max-w-2xl mx-auto space-y-6">
          <h1 className="text-2xl font-bold text-white flex gap-2"><Icon name="lock" /> Gerador de Licenças (Admin)</h1>
          <div className="bg-dark-900 p-6 rounded-xl border border-slate-700">
            <div className="grid md:grid-cols-2 gap-4 mb-4">
              <div><label className="text-slate-400 text-sm">Cliente</label><input className="w-full bg-black border border-slate-600 rounded p-2 text-white outline-none" value={name} onChange={e=>setName(e.target.value)} /></div>
              <div><label className="text-slate-400 text-sm">Dias</label><input type="number" className="w-full bg-black border border-slate-600 rounded p-2 text-white outline-none" value={days} onChange={e=>setDays(e.target.value)} /></div>
            </div>
            <button onClick={()=>{if(name) setGenKey(generateLicense(name,days))}} className="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-500">Gerar Chave</button>
            {genKey && (
              <div className="mt-4 bg-black p-4 rounded border border-brand-500/50">
                <p className="text-brand-500 text-xs font-bold mb-2 uppercase">Copie e envie para o cliente:</p>
                <div className="relative">
                  <textarea readOnly className="w-full h-24 bg-transparent text-slate-300 text-xs font-mono resize-none outline-none" value={genKey}></textarea>
                  <button onClick={() => navigator.clipboard.writeText(genKey)} className="absolute top-2 right-2 bg-slate-700 hover:bg-slate-600 text-white p-1.5 rounded text-xs flex gap-1"><Icon name="copy" size={12}/> Copiar</button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const AgentWizard = ({ onCancel, onFinish }) => {
      const [mode, setMode] = useState('direct'); // 'direct' or 'cloud'
      const [step, setStep] = useState(1);
      const [ip, setIp] = useState('');
      const [loading, setLoading] = useState(false);
      const [keys, setKeys] = useState({ sk: '', pk: '', ck: '', cpk: '' });

      useEffect(() => {
        const init = async () => {
          setLoading(true);
          setKeys({ sk: generateWGKey(), pk: generateWGKey(), ck: generateWGKey(), cpk: generateWGKey() });
          if(mode === 'direct') {
            const myIp = await getPublicIP();
            setIp(myIp);
          } else {
            setIp(''); // User must paste Oracle IP
          }
          setLoading(false);
        };
        init();
      }, [mode]);

      // --- CONFIGS ---
      // 1. Direct Mode (Home PC is Server)
      const winConfigDirect = `[Interface]\nPrivateKey = ${keys.sk}\nAddress = 10.10.0.1/24\nListenPort = 51820\nDNS = 8.8.8.8\n\n[Peer]\nPublicKey = ${keys.cpk}\nAllowedIPs = 10.10.0.2/32`.trim();
      const mobConfigDirect = `[Interface]\nPrivateKey = ${keys.ck}\nAddress = 10.10.0.2/32\nDNS = 1.1.1.1\n\n[Peer]\nPublicKey = ${keys.pk}\nEndpoint = ${ip}:51820\nAllowedIPs = 0.0.0.0/0\nPersistentKeepalive = 25`.trim();

      // 2. Cloud Mode (Oracle is Server)
      const oracleScript = `#!/bin/bash
# Auto-setup for Oracle Cloud
apt update && apt install -y wireguard
echo "net.ipv4.ip_forward=1" >> /etc/sysctl.conf
sysctl -p
cat > /etc/wireguard/wg0.conf <<EOF
[Interface]
PrivateKey = ${keys.sk}
Address = 10.10.0.1/24
ListenPort = 51820
PostUp = iptables -A FORWARD -i wg0 -j ACCEPT; iptables -t nat -A POSTROUTING -o $(ip route show default | awk '/default/ {print $5}') -j MASQUERADE
PostDown = iptables -D FORWARD -i wg0 -j ACCEPT; iptables -t nat -D POSTROUTING -o $(ip route show default | awk '/default/ {print $5}') -j MASQUERADE

[Peer]
# Client
PublicKey = ${keys.cpk}
AllowedIPs = 10.10.0.2/32
EOF
systemctl enable wg-quick@wg0
systemctl start wg-quick@wg0
echo "VPN STARTED!"
`.trim();

      const clientConfigCloud = `[Interface]\nPrivateKey = ${keys.ck}\nAddress = 10.10.0.2/32\nDNS = 1.1.1.1\n\n[Peer]\nPublicKey = ${keys.pk}\nEndpoint = ${ip}:51820\nAllowedIPs = 0.0.0.0/0\nPersistentKeepalive = 25`.trim();

      if(loading) return <div className="p-8 text-center text-slate-400">Gerando chaves...</div>;

      return (
        <div className="bg-dark-900 border border-slate-700 rounded-xl overflow-hidden">
          <div className="bg-brand-900/30 p-4 border-b border-slate-700 flex justify-between items-center">
            <h2 className="font-bold text-white">Nova Configuração</h2>
            <div className="flex gap-2 text-xs">
              <button onClick={()=>setMode('direct')} className={`px-3 py-1 rounded transition-colors ${mode==='direct'?'bg-brand-600 text-white':'bg-slate-800 text-slate-400 hover:text-white'}`}>Direto (Grátis)</button>
              <button onClick={()=>setMode('cloud')} className={`px-3 py-1 rounded transition-colors ${mode==='cloud'?'bg-purple-600 text-white':'bg-slate-800 text-slate-400 hover:text-white'}`}>Oracle (Nuvem)</button>
            </div>
          </div>

          <div className="p-6">
            {/* ETAPA 1: IP */}
            {step === 1 && (
              <div className="space-y-4">
                <p className="text-slate-300 text-sm">
                  {mode === 'direct' 
                    ? 'Detectamos seu IP. Certifique-se de abrir a porta 51820 UDP no roteador.' 
                    : 'Crie uma VM na Oracle Cloud (Always Free). Cole o IP Público dela abaixo:'}
                </p>
                <div>
                  <label className="text-xs text-slate-500 uppercase font-bold">IP do Servidor / Nuvem</label>
                  <input value={ip} onChange={e=>setIp(e.target.value)} className="w-full bg-black border border-slate-600 rounded p-2 text-white font-mono outline-none focus:border-brand-500" placeholder="Ex: 150.12.34.56" />
                </div>
                <div className="flex justify-end gap-2 mt-4">
                  <button onClick={onCancel} className="text-slate-400 px-4 py-2 hover:text-white">Cancelar</button>
                  <button onClick={()=>setStep(2)} disabled={!ip} className="bg-brand-600 hover:bg-brand-500 text-white px-6 py-2 rounded disabled:opacity-50">Próximo</button>
                </div>
              </div>
            )}

            {/* ETAPA 2: SERVIDOR */}
            {step === 2 && (
              <div className="space-y-4">
                <h3 className="text-white font-bold flex gap-2"><Icon name="server"/> {mode==='direct'?'Configurar Windows':'Configurar Oracle'}</h3>
                
                {mode === 'direct' ? (
                  <>
                    <p className="text-slate-400 text-xs">Cole no WireGuard Windows (Add empty tunnel):</p>
                    <div className="relative">
                      <textarea readOnly value={winConfigDirect} className="w-full h-32 bg-black text-green-400 text-xs font-mono p-3 rounded border border-slate-700 whitespace-pre outline-none"></textarea>
                      <button onClick={() => navigator.clipboard.writeText(winConfigDirect)} className="absolute top-2 right-2 bg-slate-700 hover:bg-slate-600 text-white p-1.5 rounded text-xs flex gap-1"><Icon name="copy" size={12}/> Copiar</button>
                    </div>
                  </>
                ) : (
                  <>
                    <p className="text-slate-400 text-xs">Cole no terminal do servidor Oracle (SSH):</p>
                    <div className="relative">
                      <textarea readOnly value={oracleScript} className="w-full h-32 bg-black text-purple-400 text-xs font-mono p-3 rounded border border-slate-700 whitespace-pre outline-none"></textarea>
                      <button onClick={() => navigator.clipboard.writeText(oracleScript)} className="absolute top-2 right-2 bg-slate-700 hover:bg-slate-600 text-white p-1.5 rounded text-xs flex gap-1"><Icon name="copy" size={12}/> Copiar</button>
                    </div>
                  </>
                )}
                
                <div className="flex justify-between mt-4">
                  <button onClick={()=>setStep(1)} className="text-slate-400 hover:text-white">Voltar</button>
                  <button onClick={()=>setStep(3)} className="bg-brand-600 text-white px-6 py-2 rounded hover:bg-brand-500">Próximo</button>
                </div>
              </div>
            )}

            {/* ETAPA 3: CLIENTE */}
            {step === 3 && (
              <div className="space-y-4">
                <h3 className="text-white font-bold flex gap-2"><Icon name="dashboard"/> Conectar Celular</h3>
                <div className="flex flex-col items-center gap-4">
                  <QRCodeDisplay value={mode==='direct'?mobConfigDirect:clientConfigCloud} />
                </div>
                <div className="bg-brand-900/40 p-3 rounded border border-brand-500/30 text-xs text-slate-300">
                  <strong>Teste Final:</strong> Desligue o Wi-Fi do celular e tente abrir o Google com a VPN ligada.
                </div>
                <div className="flex justify-between mt-4">
                  <button onClick={()=>setStep(2)} className="text-slate-400 hover:text-white">Voltar</button>
                  <button onClick={()=>onFinish({ id: Date.now(), name: mode==='direct'?'Casa':'Oracle', ip, mode })} className="bg-green-600 text-white px-6 py-2 rounded flex gap-2 hover:bg-green-500"><Icon name="shield"/> Salvar</button>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const Dashboard = ({ user, onLogout }) => {
      const [agents, setAgents] = useState(getAgents());
      const [creating, setCreating] = useState(false);

      const handleDelete = (id) => { if(confirm('Excluir?')) { deleteAgent(id); setAgents(getAgents()); } };

      return (
        <div className="flex min-h-screen">
          {/* SIDEBAR */}
          <aside className="w-64 bg-dark-900 border-r border-slate-700 hidden md:flex flex-col p-4">
            <div className="flex items-center gap-2 text-white font-bold text-xl mb-8">
              <div className="bg-brand-600 p-1 rounded"><Icon name="shield" className="text-white"/></div> Manus.ai
            </div>
            <nav className="space-y-2 flex-1">
              <div className="flex gap-3 text-brand-400 bg-brand-900/20 px-4 py-2 rounded cursor-pointer"><Icon name="dashboard"/> Dashboard</div>
              {user.type === 'admin' && <div onClick={()=>alert('Use o menu Admin na tela de login')} className="flex gap-3 text-slate-400 px-4 py-2 cursor-pointer hover:text-white"><Icon name="lock"/> Admin</div>}
            </nav>
            <button onClick={onLogout} className="flex gap-3 text-red-400 px-4 py-2 hover:bg-red-900/20 rounded"><Icon name="logout"/> Sair</button>
          </aside>

          {/* MAIN */}
          <main className="flex-1 p-4 md:p-8 overflow-y-auto">
            <header className="flex justify-between items-center mb-8">
              <div>
                <h1 className="text-2xl font-bold text-white">Bem-vindo, {user.name}</h1>
                <p className="text-slate-500 text-sm">Gerencie suas conexões seguras.</p>
              </div>
              <button onClick={()=>setCreating(true)} className="bg-brand-600 hover:bg-brand-500 text-white px-4 py-2 rounded flex gap-2 shadow-lg shadow-brand-500/20"><Icon name="plus"/> Nova Conexão</button>
            </header>

            {creating ? (
              <AgentWizard onCancel={()=>setCreating(false)} onFinish={(a)=>{ saveAgent(a); setAgents(getAgents()); setCreating(false); }} />
            ) : (
              <>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-8">
                  <div className="bg-dark-900 p-6 rounded-xl border border-slate-700">
                    <p className="text-slate-400 text-xs uppercase font-bold mb-1">Ativos</p>
                    <p className="text-3xl text-white font-bold">{agents.length}</p>
                  </div>
                  <div className="bg-dark-900 p-6 rounded-xl border border-slate-700">
                    <p className="text-slate-400 text-xs uppercase font-bold mb-1">Tipo de Licença</p>
                    <p className="text-xl text-brand-400 font-bold">{user.type === 'admin' ? 'Administrador' : 'Cliente Pro'}</p>
                  </div>
                </div>

                <h2 className="text-white font-bold mb-4">Minhas Conexões</h2>
                {agents.length === 0 ? (
                  <div className="text-center p-12 border border-dashed border-slate-700 rounded-xl">
                    <p className="text-slate-500 mb-4">Nenhuma configuração criada.</p>
                    <button onClick={()=>setCreating(true)} className="text-brand-400 hover:underline">Criar agora</button>
                  </div>
                ) : (
                  <div className="space-y-4">
                    {agents.map(a => (
                      <div key={a.id} className="bg-dark-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                        <div className="flex gap-4 items-center">
                          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${a.mode==='cloud'?'bg-purple-900/50 text-purple-400':'bg-brand-900/50 text-brand-400'}`}>
                            <Icon name={a.mode==='cloud'?'cloud':'server'} />
                          </div>
                          <div>
                            <h3 className="font-bold text-white">{a.name}</h3>
                            <p className="text-xs text-slate-500 font-mono">{a.ip}</p>
                          </div>
                        </div>
                        <button onClick={()=>handleDelete(a.id)} className="text-slate-600 hover:text-red-400"><Icon name="trash"/></button>
                      </div>
                    ))}
                  </div>
                )}
              </>
            )}
          </main>
        </div>
      );
    };

    const App = () => {
      const [user, setUser] = useState(null);
      const [view, setView] = useState('login'); 

      const handleLogin = (u) => {
        setUser(u);
        setView(u.type === 'admin' ? 'admin' : 'app');
      };

      if (!user) return <Login onLogin={handleLogin} />;
      if (view === 'admin') return (
        <div className="min-h-screen bg-dark-800 p-4">
          <button onClick={()=>setUser(null)} className="text-slate-400 mb-4 flex gap-2"><Icon name="logout"/> Sair</button>
          <LicenseGenerator />
        </div>
      );

      return <Dashboard user={user} onLogout={()=>setUser(null)} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
