<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manus.ai - Manager (Corrigido)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <!-- libsodium para gerar pares de chaves X25519 corretamente -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/libsodium-wrappers/0.7.9/libsodium-wrappers.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #1e293b; }
    ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #64748b; }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    // Small helpers
    const toB64 = (u8) => btoa(String.fromCharCode(...u8));
    const fromB64 = (s) => Uint8Array.from(atob(s), c=>c.charCodeAt(0));

    // ICON
    const Icon = ({ name, size = 20, className = "" }) => {
      const icons = {
        shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />,
        key: <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4" />,
        dashboard: <path d="M3 3h7v7H3V3zm11 0h7v7h-7V3zm0 11h7v7h-7v-7zM3 14h7v7H3v-7z" />,
        server: <path d="M2 12h20M2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6M2 12V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v6" />,
        plus: <path d="M12 5v14M5 12h14" />,
        trash: <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" />,
        help: <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 17h.01M12 14v-2a2 2 0 0 1 2-2 2 2 0 0 0-2-2" />,
        check: <path d="M20 6L9 17l-5-5" />
      };
      return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{icons[name] || <circle cx="12" cy="12" r="10" />}</svg>;
    };

    const QRCodeDisplay = ({ value }) => {
      const qrRef = useRef(null);
      useEffect(() => {
        if (qrRef.current) {
          qrRef.current.innerHTML = "";
          try { new QRCode(qrRef.current, { text: value, width: 180, height: 180, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.M }); } catch(e) {}
        }
      }, [value]);
      return <div className="bg-white p-4 rounded shadow-lg mx-auto w-fit" ref={qrRef}></div>;
    };

    // Local storage helpers for agents
    const getAgents = () => JSON.parse(localStorage.getItem('manus_agents_v3') || '[]');
    const saveAgent = (a) => { const l = getAgents(); localStorage.setItem('manus_agents_v3', JSON.stringify([...l.filter(x => x.id !== a.id), a])); };
    const deleteAgent = (id) => localStorage.setItem('manus_agents_v3', JSON.stringify(getAgents().filter(a => a.id !== id)));

    // --- AgentWizard with libsodium keypair generation ---
    const AgentWizard = ({ onCancel, onFinish }) => {
      const [mode, setMode] = useState('direct');
      const [step, setStep] = useState(1);
      const [ip, setIp] = useState('');
      const [serverKeypair, setServerKeypair] = useState(null);
      const [clientKeypair, setClientKeypair] = useState(null);
      const [sodiumReady, setSodiumReady] = useState(false);

      useEffect(()=>{
        // init libsodium
        (async ()=>{
          if (window.sodium) {
            await window.sodium.ready;
            setSodiumReady(true);
          }
        })();
      },[]);

      useEffect(() => {
        // when ready, generate keypairs
        if (!sodiumReady) return;
        const gen = () => {
          // crypto_box_keypair returns Curve25519 keypair which is suitable for WireGuard public/private (32 bytes)
          const kpServer = window.sodium.crypto_box_keypair();
          const kpClient = window.sodium.crypto_box_keypair();
          setServerKeypair({ sk: kpServer.privateKey, pk: kpServer.publicKey });
          setClientKeypair({ sk: kpClient.privateKey, pk: kpClient.publicKey });
        };
        gen();
      }, [sodiumReady, mode]);

      useEffect(()=>{ if(mode==='direct') { (async ()=>{ try { const res = await fetch('https://api.ipify.org?format=json'); const j = await res.json(); setIp(j.ip); } catch { setIp('SEU_IP_AQUI'); } })(); } else setIp('ENDERECO_DA_VM:PORT'); }, [mode]);

      // create config strings when keypairs are ready
      const winConf = serverKeypair ? `# Importe este arquivo no WireGuard (Windows)\n[Interface]\nPrivateKey = ${toB64(serverKeypair.sk)}\nAddress = 10.10.0.1/24\nListenPort = 51820\nDNS = 8.8.8.8\n\n[Peer]\nPublicKey = ${toB64(clientKeypair.sk ? clientKeypair.pk : new Uint8Array())}\nAllowedIPs = 10.10.0.2/32`.trim() : '# Gerando chaves...';

      const mobConf = clientKeypair ? `# Importe no app WireGuard do celular\n[Interface]\nPrivateKey = ${toB64(clientKeypair.sk)}\nAddress = 10.10.0.2/32\nDNS = 1.1.1.1\n\n[Peer]\nPublicKey = ${toB64(serverKeypair ? serverKeypair.pk : new Uint8Array())}\nEndpoint = ${ip}:51820\nAllowedIPs = 0.0.0.0/0\nPersistentKeepalive = 25`.trim() : '# Gerando chaves...';

      return (
        <div className="bg-dark-900 border border-slate-700 rounded-xl overflow-hidden p-6">
          <div className="flex justify-between items-center mb-6 border-b border-slate-700 pb-4">
            <h2 className="font-bold text-white text-xl">Nova Conexão</h2>
            <div className="flex gap-2 text-xs">
               <button onClick={()=>setMode('direct')} className={`px-3 py-1 rounded ${mode==='direct'?'bg-brand-600 text-white':'bg-slate-800 text-slate-400'}`}>Direto</button>
               <button onClick={()=>setMode('cloud')} className={`px-3 py-1 rounded ${mode==='cloud'?'bg-purple-600 text-white':'bg-slate-800 text-slate-400'}`}>Nuvem</button>
            </div>
          </div>

          {step === 1 && (
            <div className="space-y-4">
               <p className="text-slate-400 text-sm">{mode==='direct' ? 'Detectamos seu IP público automaticamente. Garanta que a porta 51820/UDP esteja encaminhada para o seu PC.' : 'Cole aqui o IP:PORT da sua VM na nuvem.'}</p>
               <input value={ip} onChange={e=>setIp(e.target.value)} className="w-full bg-black border border-slate-600 rounded p-2 text-white font-mono" />
               <div className="flex justify-end gap-2 mt-4">
                 <button onClick={onCancel} className="text-slate-400 px-4">Cancelar</button>
                 <button onClick={()=>setStep(2)} disabled={!ip} className="bg-brand-600 text-white px-6 py-2 rounded">Próximo</button>
               </div>
            </div>
          )}

          {step === 2 && (
             <div className="space-y-4">
               <p className="text-slate-400 text-sm">Importante: iremos gerar um par de chaves para o servidor (Windows) e para o cliente (celular). Você pode importar o <strong>winConf</strong> diretamente no WireGuard Windows (Menu &gt; Add Tunnel &gt; Add empty tunnel &gt; colar) ou usar o botão <strong>Exportar</strong>.</p>
               <div>
                 <label className="text-xs text-slate-400">Configuração para o Windows (importar no WireGuard):</label>
                 <textarea readOnly value={winConf} className="w-full h-36 bg-black text-green-400 text-xs font-mono p-4 rounded border border-slate-700 resize-none" onClick={e=>e.target.select()}></textarea>
               </div>
               <div>
                 <label className="text-xs text-slate-400">Configuração para o Celular (importar no app WireGuard):</label>
                 <textarea readOnly value={mobConf} className="w-full h-36 bg-black text-green-400 text-xs font-mono p-4 rounded border border-slate-700 resize-none" onClick={e=>e.target.select()}></textarea>
               </div>
               <div className="flex justify-between mt-4">
                 <button onClick={()=>setStep(1)} className="text-slate-400">Voltar</button>
                 <button onClick={()=>setStep(3)} className="bg-brand-600 text-white px-6 py-2 rounded" disabled={!serverKeypair || !clientKeypair}>Próximo</button>
               </div>
             </div>
          )}

          {step === 3 && (
            <div className="space-y-4 text-center">
               <p className="text-slate-400 text-sm">Escaneie o QR Code com seu celular ou copie a configuração manualmente.</p>
               <QRCodeDisplay value={mobConf} />
               <div className="bg-dark-900 border border-slate-700 p-3 rounded mt-4 text-left text-xs text-slate-400">
                  <strong>Teste Final:</strong> Depois de importar no Windows e no celular, ative a interface no Windows e conecte o celular na rede móvel (4G). Verifique os logs do WireGuard no Windows para confirmar o handshake.
               </div>
               <div className="flex justify-between mt-6">
                 <button onClick={()=>setStep(2)} className="text-slate-400">Voltar</button>
                 <button onClick={()=>{ onFinish({id:Date.now(), name:'Casa', ip, mode}); }} className="bg-green-600 text-white px-6 py-2 rounded flex gap-2 mx-auto"><Icon name="check"/> Salvar</button>
               </div>
            </div>
          )}
        </div>
      );
    };

    const Troubleshooting = ({ onBack }) => (
      <div className="space-y-6">
        <h2 className="text-2xl font-bold text-white flex gap-2"><Icon name="help"/> Ajuda & Diagnóstico</h2>
        <div className="grid gap-6 md:grid-cols-2">
          <div className="bg-dark-900 border border-slate-700 p-6 rounded-xl">
            <h3 className="text-red-400 font-bold mb-2">Erro: Handshake did not complete</h3>
            <p className="text-sm text-slate-300 mb-2">Siga os passos abaixo. Muitos problemas são firewall local ou interface mal importada.</p>
            <div className="bg-red-900/20 p-4 rounded border border-red-500/30 mb-4">
               <h4 className="text-red-200 font-bold text-sm mb-2">Firewall do Windows</h4>
               <ol className="list-decimal pl-4 text-xs text-red-100 space-y-1">
                  <li>Abra: "Firewall e proteção de rede".</li>
                  <li>Clique na rede ativa e temporariamente desative o Firewall do Windows Defender para testar.</li>
                  <li>Se funcionar: reative o firewall e deixe apenas a regra para a porta <strong>51820 UDP</strong> liberada para o app WireGuard.</li>
               </ol>
            </div>
          </div>
          <div className="bg-dark-900 border border-slate-700 p-6 rounded-xl">
            <h3 className="text-purple-400 font-bold mb-2">Encaminhamento de Porta</h3>
            <p className="text-sm text-slate-300 mb-2">No roteador, faça NAT/Port Forwarding da porta <strong>51820 UDP</strong> para o IP local do seu PC (ex: 192.168.0.56). Se você já tem IP público (não CGNAT), isso permitirá o celular alcançar o PC.</p>
          </div>
        </div>
        <button onClick={onBack} className="text-slate-400 hover:text-white">Voltar</button>
      </div>
    );

    const Dashboard = ({ user, onLogout }) => {
      const [agents, setAgents] = useState(getAgents());
      const [view, setView] = useState('list');
      return (
        <div className="flex min-h-screen">
          <aside className="w-64 bg-dark-900 border-r border-slate-700 hidden md:flex flex-col p-4">
            <div className="flex items-center gap-2 text-white font-bold text-xl mb-8"><div className="bg-brand-600 p-1 rounded"><Icon name="shield" className="text-white"/></div> Manus.ai</div>
            <nav className="space-y-2 flex-1">
              <div onClick={()=>setView('list')} className={`flex gap-3 px-4 py-2 rounded cursor-pointer ${view==='list'?'bg-brand-900/30 text-brand-400':'text-slate-400'}`}><Icon name="dashboard"/> Dashboard</div>
              <div onClick={()=>setView('help')} className={`flex gap-3 px-4 py-2 rounded cursor-pointer ${view==='help'?'bg-brand-900/30 text-brand-400':'text-slate-400'}`}><Icon name="help"/> Ajuda / Erros</div>
            </nav>
            <button onClick={onLogout} className="flex gap-3 text-red-400 px-4 py-2 hover:bg-red-900/20 rounded"><Icon name="logout"/> Sair</button>
          </aside>
          <main className="flex-1 p-8 overflow-y-auto">
            {view === 'help' && <Troubleshooting onBack={()=>setView('list')} />}
            {view === 'create' && <AgentWizard onCancel={()=>setView('list')} onFinish={(a)=>{ saveAgent(a); setAgents(getAgents()); setView('list'); }} />}
            {view === 'list' && (
              <>
                <header className="flex justify-between items-center mb-8">
                  <h1 className="text-2xl font-bold text-white">Olá, {user.name}</h1>
                  <button onClick={()=>setView('create')} className="bg-brand-600 hover:bg-brand-500 text-white px-4 py-2 rounded flex gap-2"><Icon name="plus"/> Nova Conexão</button>
                </header>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                  <div className="bg-dark-900 p-6 rounded-xl border border-slate-700"><p className="text-slate-400 text-xs uppercase font-bold">Ativos</p><p className="text-3xl text-white font-bold">{agents.length}</p></div>
                </div>
                <div className="space-y-4">
                  {agents.map(a => (
                    <div key={a.id} className="bg-dark-900 p-4 rounded-xl border border-slate-700 flex justify-between items-center">
                       <div className="flex gap-4 items-center">
                          <div className={`w-10 h-10 rounded-full flex items-center justify-center bg-brand-900/30 text-brand-400`}><Icon name="server" /></div>
                          <div><h3 className="font-bold text-white">{a.name}</h3><p className="text-xs text-slate-500 font-mono">{a.ip}</p></div>
                       </div>
                       <button onClick={()=>{if(confirm('Apagar?')) {deleteAgent(a.id); setAgents(getAgents());}}} className="text-slate-600 hover:text-red-400"><Icon name="trash"/></button>
                    </div>
                  ))}
                </div>
              </>
            )}
          </main>
        </div>
      );
    };

    const Login = ({ onLogin }) => {
      const [k, setK] = useState(''); const [e, setE] = useState('');
      const validateLicense = (k) => { if (!k) return null; if (k === 'manus-admin-2024') return { type: 'admin', name: 'Admin' }; try{ const p = JSON.parse(atob(k)); if (p.s !== btoa(p.c + p.e + 'manus_secret_salt_v1') || Date.now() > p.e) return null; return { type: 'client', name: p.c }; } catch { return null; } };
      return (
        <div className="min-h-screen bg-dark-800 flex items-center justify-center p-4">
          <div className="w-full max-w-md bg-dark-900 border border-slate-700 p-8 rounded-2xl">
             <div className="flex justify-center mb-6"><div className="w-16 h-16 bg-brand-600 rounded-2xl flex items-center justify-center"><Icon name="shield" size={40} className="text-white"/></div></div>
             <h1 className="text-2xl font-bold text-center text-white mb-6">Acesso Manus.ai</h1>
             <input className="w-full bg-black border border-slate-600 rounded p-3 text-white text-center mb-4 outline-none focus:border-brand-500" placeholder="Chave de Licença" value={k} onChange={e=>setK(e.target.value)} />
             {e && <p className="text-red-400 text-sm text-center mb-4">{e}</p>}
             <button onClick={()=>{ const r=validateLicense(k.trim()); if(r) onLogin(r); else setE('Chave inválida'); }} className="w-full bg-brand-600 text-white font-bold py-3 rounded">Entrar</button>
          </div>
        </div>
      );
    };

    const LicenseGen = () => {
      const SALT = 'manus_secret_salt_v1';
      const [n, setN] = useState(''); const [d, setD] = useState(30); const [k, setK] = useState('');
      const generateLicense = (c, days) => { const e = new Date(); e.setDate(e.getDate() + parseInt(days)); const p = { c, e: e.getTime(), s: btoa(c + e.getTime() + SALT) }; return btoa(JSON.stringify(p)); };
      return (
        <div className="min-h-screen bg-dark-800 p-8"><div className="max-w-xl mx-auto space-y-4"><h1 className="text-white font-bold text-2xl mb-4">Gerador Admin</h1><input className="w-full bg-black border border-slate-700 rounded p-2 text-white" placeholder="Nome" value={n} onChange={e=>setN(e.target.value)} /><input type="number" className="w-full bg-black border border-slate-700 rounded p-2 text-white" value={d} onChange={e=>setD(e.target.value)} /><button onClick={()=>setK(generateLicense(n,d))} className="w-full bg-green-600 text-white font-bold py-2 rounded">Gerar</button>{k && <textarea readOnly className="w-full h-24 bg-black text-slate-300 text-xs p-2 rounded border border-brand-500" value={k} onClick={e=>e.target.select()} />}</div></div>
      );
    };

    const App = () => {
      const [u, setU] = useState(null);
      if (!u) return <Login onLogin={setU} />;
      if (u.type === 'admin') return <LicenseGen />;
      return <Dashboard user={u} onLogout={()=>setU(null)} />;
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
